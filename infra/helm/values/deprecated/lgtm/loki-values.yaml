# Loki Helm Values - Log Aggregation
# NIST AU-2: Audit Events, AU-11: Audit Record Retention

loki:
  # Loki v3 architecture - scalable mode
  auth_enabled: false

  # Schema configuration
  schemaConfig:
    configs:
      - from: "2024-01-01"
        store: tsdb
        object_store: s3
        schema: v13
        index:
          prefix: loki_index_
          period: 24h

  # Storage configuration for AWS S3
  # NIST SC-28: Encryption at Rest, SC-8: Encryption in Transit
  storage:
    type: s3
    bucketNames:
      chunks: infra-agent-dev-loki-340752837296
      ruler: infra-agent-dev-loki-340752837296
      admin: infra-agent-dev-loki-340752837296
    s3:
      region: us-east-1
      endpoint: null
      secretAccessKey: null
      accessKeyId: null
      s3ForcePathStyle: false
      insecure: false

  # Ingester configuration
  ingester:
    chunk_encoding: snappy
    chunk_idle_period: 30m
    chunk_block_size: 262144
    chunk_retain_period: 1m

  # Limits configuration
  limits_config:
    retention_period: 90d  # NIST AU-11: 90-day retention
    max_query_series: 5000
    max_query_parallelism: 32
    ingestion_rate_mb: 10
    ingestion_burst_size_mb: 20
    per_stream_rate_limit: 3MB
    per_stream_rate_limit_burst: 15MB

  # Compactor for retention
  compactor:
    working_directory: /var/loki/compactor
    retention_enabled: true
    retention_delete_delay: 2h
    delete_request_store: s3

# Deployment mode - scalable
deploymentMode: SimpleScalable

# Read replicas
read:
  replicas: 2
  resources:
    requests:
      cpu: 100m
      memory: 256Mi
    limits:
      cpu: 500m
      memory: 512Mi

# Write replicas
write:
  replicas: 2
  resources:
    requests:
      cpu: 100m
      memory: 256Mi
    limits:
      cpu: 500m
      memory: 512Mi

# Backend replicas
backend:
  replicas: 2
  resources:
    requests:
      cpu: 100m
      memory: 256Mi
    limits:
      cpu: 500m
      memory: 512Mi

# Gateway configuration
gateway:
  enabled: true
  replicas: 2
  service:
    type: ClusterIP
    port: 3100

# Monitoring
# Disable selfMonitoring as it requires Grafana Agent Operator CRDs
monitoring:
  selfMonitoring:
    enabled: false
    grafanaAgent:
      installOperator: false

  lokiCanary:
    enabled: false

# Service account for IRSA
# NIST AC-6: Least Privilege via IRSA role
serviceAccount:
  create: true
  name: loki
  annotations:
    eks.amazonaws.com/role-arn: arn:aws:iam::340752837296:role/infra-agent-dev-loki-role

# Persistence
persistence:
  enabled: true
  size: 10Gi
  storageClass: gp3
