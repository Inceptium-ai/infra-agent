# Mimir Helm Values - Metrics Storage
# NIST AU-2: Audit Events (metrics collection)
# NIST AU-9: Protection of Audit Information (Kafka WAL provides durability)

# =============================================================================
# KAFKA CONFIGURATION (Write-Ahead Log for Durability)
# =============================================================================
# Kafka acts as a WAL between Distributor and Ingester:
#   Prometheus -> Distributor -> Kafka (WAL) -> Ingester -> S3
#
# Benefits:
#   - Durability: If ingester crashes, metrics replay from Kafka
#   - Decoupling: Distributors don't block on slow ingesters
#   - Scaling: Add/remove ingesters without data loss
#
# Trade-off: Requires StatefulSet with PVC (EBS is AZ-bound)
# =============================================================================
kafka:
  enabled: true
  replicas: 1
  persistence:
    enabled: true
    size: 5Gi
    storageClass: gp3
  resources:
    requests:
      cpu: 500m
      memory: 1Gi
    limits:
      cpu: 1
      memory: 2Gi

# Deployment mode: distributed for production
mimir:
  # Structured config
  structuredConfig:
    # Enable Kafka-based ingest storage (Mimir 3.0+)
    ingest_storage:
      enabled: true
      kafka:
        address: mimir-kafka.observability.svc.cluster.local:9092
    common:
      storage:
        backend: s3
        s3:
          bucket_name: infra-agent-dev-mimir-340752837296
          endpoint: s3.us-east-1.amazonaws.com
          region: us-east-1

    blocks_storage:
      backend: s3
      s3:
        bucket_name: infra-agent-dev-mimir-340752837296

    ruler_storage:
      backend: s3
      s3:
        bucket_name: infra-agent-dev-mimir-340752837296

    alertmanager_storage:
      backend: s3
      s3:
        bucket_name: infra-agent-dev-mimir-340752837296

# Service account for IRSA
serviceAccount:
  create: true
  name: mimir
  annotations:
    eks.amazonaws.com/role-arn: arn:aws:iam::340752837296:role/infra-agent-dev-mimir-role

# Gateway (nginx) for routing
nginx:
  enabled: true
  replicas: 2
  resources:
    requests:
      cpu: 50m
      memory: 64Mi
    limits:
      cpu: 200m
      memory: 256Mi

# Distributor - receives metrics
distributor:
  replicas: 2
  resources:
    requests:
      cpu: 100m
      memory: 256Mi
    limits:
      cpu: 500m
      memory: 512Mi

# Ingester - writes to storage
# NOTE: Ingesters need significant memory for WAL replay during startup
# OOMKilled at 1Gi and 2Gi - increased to 4Gi for stability
# WAL replay during startup can consume 2-3GB temporarily
ingester:
  replicas: 2
  persistentVolume:
    enabled: true
    size: 10Gi
    storageClass: gp3
  resources:
    requests:
      cpu: 200m
      memory: 2Gi
    limits:
      cpu: 2
      memory: 4Gi

# Querier - reads from storage
querier:
  replicas: 2
  resources:
    requests:
      cpu: 100m
      memory: 256Mi
    limits:
      cpu: 500m
      memory: 512Mi

# Query frontend
query_frontend:
  replicas: 1
  resources:
    requests:
      cpu: 50m
      memory: 128Mi
    limits:
      cpu: 200m
      memory: 256Mi

# Store gateway - reads blocks from S3
store_gateway:
  replicas: 1
  persistentVolume:
    enabled: true
    size: 10Gi
    storageClass: gp3
  resources:
    requests:
      cpu: 100m
      memory: 256Mi
    limits:
      cpu: 500m
      memory: 512Mi

# Compactor - compacts blocks
compactor:
  replicas: 1
  persistentVolume:
    enabled: true
    size: 10Gi
    storageClass: gp3
  resources:
    requests:
      cpu: 100m
      memory: 256Mi
    limits:
      cpu: 500m
      memory: 512Mi

# Ruler (for alerting rules)
ruler:
  enabled: false  # Enable later if needed

# Alertmanager
alertmanager:
  enabled: false  # Enable later if needed

# Disable minio (using S3)
minio:
  enabled: false

# Monitoring
metaMonitoring:
  serviceMonitor:
    enabled: false  # Requires Prometheus Operator CRDs

# Results cache
results_cache:
  enabled: true
  allocatedMemory: 512

# Chunks cache
chunks_cache:
  enabled: true
  allocatedMemory: 512
