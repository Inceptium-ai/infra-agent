# Grafana Helm Values - Observability Dashboard
# NIST AU-2: Audit Events (visualization)

# Replica count for HA
replicas: 2

# Image configuration
image:
  repository: grafana/grafana
  tag: 11.4.0
  pullPolicy: IfNotPresent

# Service configuration
service:
  type: ClusterIP
  port: 3000

# Ingress configuration (will use Istio Gateway)
ingress:
  enabled: false

# Resource limits
resources:
  requests:
    cpu: 100m
    memory: 256Mi
  limits:
    cpu: 500m
    memory: 512Mi

# Persistence
persistence:
  enabled: true
  size: 10Gi
  storageClass: gp3

# Admin credentials (should be overridden via secrets)
adminUser: admin
# adminPassword will be generated and stored in secret

# Grafana configuration
grafana.ini:
  server:
    root_url: "%(protocol)s://%(domain)s/"
    serve_from_sub_path: false

  auth:
    disable_login_form: false
    disable_signout_menu: false

  auth.anonymous:
    enabled: false

  security:
    admin_user: admin
    # admin_password will be from secret
    cookie_secure: true
    strict_transport_security: true
    strict_transport_security_max_age_seconds: 86400

  users:
    allow_sign_up: false
    allow_org_create: false

  log:
    mode: console
    level: info

  analytics:
    reporting_enabled: false
    check_for_updates: false

# Data sources configuration
datasources:
  datasources.yaml:
    apiVersion: 1
    datasources:
      # Loki for logs
      - name: Loki
        type: loki
        access: proxy
        url: http://loki-gateway.observability.svc.cluster.local:3100
        isDefault: false
        jsonData:
          maxLines: 1000

      # Tempo for traces
      - name: Tempo
        type: tempo
        access: proxy
        url: http://tempo.observability.svc.cluster.local:3200
        isDefault: false
        jsonData:
          tracesToLogsV2:
            datasourceUid: loki
            spanStartTimeShift: '-1h'
            spanEndTimeShift: '1h'
            filterByTraceID: true
            filterBySpanID: false
          tracesToMetrics:
            datasourceUid: mimir
          serviceMap:
            datasourceUid: mimir
          nodeGraph:
            enabled: true
          search:
            hide: false
          lokiSearch:
            datasourceUid: loki

      # Mimir for metrics (Prometheus-compatible)
      - name: Mimir
        type: prometheus
        access: proxy
        url: http://mimir-gateway.observability.svc.cluster.local:80/prometheus
        isDefault: true
        jsonData:
          timeInterval: 15s
          exemplarTraceIdDestinations:
            - name: traceID
              datasourceUid: tempo

# Dashboard providers
dashboardProviders:
  dashboardproviders.yaml:
    apiVersion: 1
    providers:
      - name: default
        orgId: 1
        folder: ''
        type: file
        disableDeletion: false
        editable: true
        options:
          path: /var/lib/grafana/dashboards/default

# Pre-configured dashboards
dashboards:
  default:
    # Kubernetes cluster monitoring
    kubernetes-cluster:
      gnetId: 7249
      revision: 1
      datasource: Mimir

    # Node exporter
    node-exporter:
      gnetId: 1860
      revision: 37
      datasource: Mimir

    # Istio mesh dashboard
    istio-mesh:
      gnetId: 7639
      revision: 227
      datasource: Mimir

    # Istio service dashboard
    istio-service:
      gnetId: 7636
      revision: 227
      datasource: Mimir

    # Loki logs dashboard
    loki-logs:
      gnetId: 13639
      revision: 2
      datasource: Loki

# Sidecar for dashboard auto-discovery
sidecar:
  dashboards:
    enabled: true
    label: grafana_dashboard
    labelValue: "1"
    searchNamespace: ALL

  datasources:
    enabled: true
    label: grafana_datasource
    labelValue: "1"

# Pod affinity for HA
affinity:
  podAntiAffinity:
    preferredDuringSchedulingIgnoredDuringExecution:
      - weight: 100
        podAffinityTerm:
          labelSelector:
            matchLabels:
              app.kubernetes.io/name: grafana
          topologyKey: kubernetes.io/hostname

# Service account
serviceAccount:
  create: true
  name: grafana
  annotations: {}

# Pod disruption budget
podDisruptionBudget:
  minAvailable: 1

# Plugins to install
plugins:
  - grafana-clock-panel
  - grafana-piechart-panel
  - grafana-polystat-panel

# Environment variables
env:
  GF_EXPLORE_ENABLED: true
  GF_FEATURE_TOGGLES_ENABLE: traceqlEditor
