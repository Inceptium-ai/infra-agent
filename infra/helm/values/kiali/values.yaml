# Kiali Helm Values - Traffic Visualization for Istio Service Mesh
# NIST AU-6: Security Review and Analysis - Visualize service communication patterns
#
# Kiali provides:
# - Real-time traffic flow visualization
# - Service mesh topology graph
# - Health monitoring for Istio workloads
# - Configuration validation
#
# Prerequisites:
# - Istio installed in istio-system namespace
# - Prometheus metrics available
#
# Install:
#   helm repo add kiali https://kiali.org/helm-charts
#   helm repo update
#   helm upgrade --install kiali-operator kiali/kiali-operator \
#     -n kiali-operator --create-namespace \
#     -f infra/helm/values/kiali/values.yaml
#
# Access (after tunnel):
#   kubectl port-forward svc/kiali 20001:20001 -n istio-system
#   Open http://localhost:20001/kiali
#
# ALB Access:
#   https://<alb-url>/kiali/
---

# Kiali Operator configuration
cr:
  create: true
  namespace: istio-system
  spec:
    # Authentication - anonymous since ALB + Cognito handles auth at edge
    # NIST IA-2: User authentication enforced by ALB + Cognito
    auth:
      strategy: anonymous

    # Deployment configuration
    deployment:
      accessible_namespaces:
        - "**"
      replicas: 1
      resources:
        requests:
          cpu: 50m
          memory: 128Mi
        limits:
          cpu: 500m
          memory: 512Mi
      # Service type - NodePort for ALB target group
      # Kiali operator assigns NodePort dynamically (currently 30520)
      # CloudFormation ALB target group configured to match
      service_type: NodePort
      # Pod labels for identification
      pod_labels:
        app.kubernetes.io/name: kiali
        app.kubernetes.io/component: observability
        app.kubernetes.io/managed-by: infra-agent

    # External services configuration
    external_services:
      # Prometheus - minimal instance for Istio metrics (Kiali graph)
      # SigNoz handles full observability; this Prometheus is ONLY for Kiali
      prometheus:
        url: "http://prometheus-kiali-prometheus-kiali.istio-system.svc.cluster.local:9090"

      # Tracing - disabled (SigNoz handles traces, Kiali focuses on graph)
      tracing:
        enabled: false

      # Grafana - disabled, using SigNoz dashboards instead
      grafana:
        enabled: false

      # Istio configuration
      istio:
        root_namespace: istio-system
        component_status:
          enabled: true
          components:
            - app_label: istiod
              is_core: true
              namespace: istio-system

    # Server configuration
    server:
      port: 20001
      web_root: "/kiali"
      web_fqdn: ""
      web_schema: ""

    # Istio namespace
    istio_namespace: istio-system

    # Health configuration
    health_config:
      rate: []

    # Kiali feature flags
    kiali_feature_flags:
      validations:
        ignore:
          - "KIA1301"  # Ignore virtual service host warning for demo

# Operator settings
operator:
  resources:
    requests:
      cpu: 10m
      memory: 64Mi
    limits:
      cpu: 100m
      memory: 128Mi
