# Velero Helm Values - Backup and Disaster Recovery
# NIST CP-9: System Backup, CP-10: System Recovery

# Image configuration (chart 11.3.1 uses default image v1.17.1)
# image:
#   repository: velero/velero
#   tag: v1.17.1
#   pullPolicy: IfNotPresent

# Init containers for plugins (compatible with Velero 1.17.x)
initContainers:
  - name: velero-plugin-for-aws
    image: velero/velero-plugin-for-aws:v1.12.0
    imagePullPolicy: IfNotPresent
    volumeMounts:
      - name: plugins
        mountPath: /target

# Resource limits
resources:
  requests:
    cpu: 100m
    memory: 128Mi
  limits:
    cpu: 500m
    memory: 512Mi

# Backup storage configuration
configuration:
  # Default backup storage location
  backupStorageLocation:
    - name: default
      provider: aws
      bucket: infra-agent-dev-velero-340752837296
      prefix: velero
      config:
        region: us-east-1

  # Volume snapshot location
  volumeSnapshotLocation:
    - name: default
      provider: aws
      config:
        region: us-east-1

  # Default volumes to fs-backup
  defaultVolumesToFsBackup: true

  # Backup sync period
  backupSyncPeriod: 1m

  # TTL for backups
  defaultBackupTTL: 720h  # 30 days

  # Restore resource priorities
  restoreResourcePriorities:
    - namespaces
    - storageclasses
    - persistentvolumes
    - persistentvolumeclaims
    - secrets
    - configmaps
    - serviceaccounts
    - limitranges
    - pods

# Credentials configuration
# Using IRSA - no static credentials needed
credentials:
  useSecret: false

# Service account for IRSA
# NIST AC-6: Least Privilege via IRSA role
serviceAccount:
  server:
    create: true
    name: velero
    annotations:
      eks.amazonaws.com/role-arn: arn:aws:iam::340752837296:role/infra-agent-dev-velero-role

# Deploy node-agent for file system backups
deployNodeAgent: true

nodeAgent:
  resources:
    requests:
      cpu: 100m
      memory: 128Mi
    limits:
      cpu: 500m
      memory: 512Mi

  # Disable Istio sidecar injection for DaemonSet
  # DaemonSets don't need mTLS - they perform local backup operations
  # Sidecar adds ~100m CPU overhead causing scheduling failures
  podAnnotations:
    sidecar.istio.io/inject: "false"

  # Tolerate all taints
  tolerations:
    - operator: Exists

# Backup schedules
schedules:
  # Daily backup of all namespaces
  daily-backup:
    disabled: false
    schedule: "0 2 * * *"  # 2 AM UTC daily
    template:
      ttl: 168h  # 7 days
      includedNamespaces:
        - "*"
      excludedNamespaces:
        - kube-system
        - velero
      includeClusterResources: true
      storageLocation: default

  # Weekly full backup with longer retention
  weekly-backup:
    disabled: false
    schedule: "0 3 * * 0"  # 3 AM UTC every Sunday
    template:
      ttl: 720h  # 30 days
      includedNamespaces:
        - "*"
      excludedNamespaces:
        - kube-system
      includeClusterResources: true
      storageLocation: default

  # SigNoz observability platform backup (high frequency)
  # CRITICAL: Ensures rapid recovery of observability stack
  # See: docs/lessons-learned.md #53 - StatefulSet PV AZ-Binding Incident
  signoz-backup:
    disabled: false
    schedule: "0 */6 * * *"  # Every 6 hours
    template:
      ttl: 168h  # 7 days retention
      includedNamespaces:
        - signoz
      includeClusterResources: false
      storageLocation: default
      # Snapshot PVCs for faster recovery
      snapshotVolumes: true
      # Include all PV data
      defaultVolumesToFsBackup: true

  # Cross-region DR backup (disabled - no DR bucket configured)
  # dr-backup:
  #   disabled: false
  #   schedule: "0 4 * * *"
  #   template:
  #     ttl: 336h
  #     includedNamespaces:
  #       - "*"
  #     excludedNamespaces:
  #       - kube-system
  #       - velero
  #     includeClusterResources: true
  #     storageLocation: dr

# Metrics
metrics:
  enabled: true
  serviceMonitor:
    enabled: false  # Disabled - requires Prometheus Operator CRDs
    additionalLabels:
      release: prometheus

# RBAC
rbac:
  create: true
  clusterAdministrator: true

# Skip CRD upgrade (uses bitnami kubectl image which requires subscription)
upgradeCRDs: false
