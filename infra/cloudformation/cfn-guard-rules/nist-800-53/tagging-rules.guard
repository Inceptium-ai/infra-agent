# NIST 800-53 Rev 5 - CM-8 System Inventory Tagging Rules
# Infrastructure Agent - Mandatory Tagging Validation

#############################################
# Security Group Tagging (CM-8)
#############################################

rule security_group_has_environment_tag {
    AWS::EC2::SecurityGroup {
        Properties.Tags EXISTS
        some Properties.Tags[*].Key == "Environment"
        <<
            CM-8: Security Groups must have an Environment tag
        >>
    }
}

#############################################
# IAM Role Tagging (CM-8)
#############################################

rule iam_role_has_environment_tag {
    AWS::IAM::Role {
        Properties.Tags EXISTS
        some Properties.Tags[*].Key == "Environment"
        <<
            CM-8: IAM Roles must have an Environment tag
        >>
    }
}

#############################################
# EKS Cluster Tagging (CM-8)
#############################################

rule eks_cluster_has_mandatory_tags {
    AWS::EKS::Cluster {
        Properties.Tags EXISTS
        some Properties.Tags[*].Key == "Environment"
        some Properties.Tags[*].Key == "Owner"
        <<
            CM-8: EKS Clusters must have Environment and Owner tags
        >>
    }
}

#############################################
# S3 Bucket Tagging (CM-8)
#############################################

rule s3_bucket_has_mandatory_tags {
    AWS::S3::Bucket {
        Properties.Tags EXISTS
        some Properties.Tags[*].Key == "Environment"
        some Properties.Tags[*].Key == "Owner"
        <<
            CM-8: S3 Buckets must have Environment and Owner tags
        >>
    }
}

#############################################
# RDS Instance Tagging (CM-8)
#############################################

rule rds_instance_has_mandatory_tags {
    AWS::RDS::DBInstance {
        Properties.Tags EXISTS
        some Properties.Tags[*].Key == "Environment"
        some Properties.Tags[*].Key == "Owner"
        <<
            CM-8: RDS instances must have Environment and Owner tags
        >>
    }
}

#############################################
# Load Balancer Tagging (CM-8)
#############################################

rule alb_has_mandatory_tags {
    AWS::ElasticLoadBalancingV2::LoadBalancer {
        Properties.Tags EXISTS
        some Properties.Tags[*].Key == "Environment"
        some Properties.Tags[*].Key == "Owner"
        <<
            CM-8: Application Load Balancers must have Environment and Owner tags
        >>
    }
}

#############################################
# Cognito User Pool Tagging (CM-8)
#############################################

rule cognito_user_pool_has_tags {
    AWS::Cognito::UserPool {
        Properties.UserPoolTags EXISTS
        <<
            CM-8: Cognito User Pools must have tags defined
        >>
    }
}
