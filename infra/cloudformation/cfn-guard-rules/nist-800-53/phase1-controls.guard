# NIST 800-53 Rev 5 Phase 1 Controls for cfn-guard 3.x
# Infrastructure Agent - Zero Trust Network Foundation

#############################################
# RDS Security Controls
#############################################

# Rule: RDS instances must have encryption enabled
rule rds_encryption {
    AWS::RDS::DBInstance {
        Properties.StorageEncrypted == true
        <<
            NIST SC-28: RDS instances must have storage encryption enabled
        >>
    }
}

# Rule: RDS instances must not be publicly accessible
rule rds_not_public {
    AWS::RDS::DBInstance {
        Properties.PubliclyAccessible == false
        <<
            NIST SC-7: RDS instances must not be publicly accessible
        >>
    }
}

# Rule: RDS instances must use a DB Subnet Group
rule rds_subnet_group {
    AWS::RDS::DBInstance {
        Properties.DBSubnetGroupName EXISTS
        <<
            NIST SC-7: RDS instances must use a DB Subnet Group (private subnets)
        >>
    }
}

#############################################
# S3 Security Controls
#############################################

# Rule: S3 buckets must have encryption enabled
rule s3_encryption {
    AWS::S3::Bucket {
        Properties.BucketEncryption EXISTS
        <<
            NIST SC-28: S3 Buckets must have server-side encryption enabled
        >>
    }
}

# Rule: S3 buckets must block public access
rule s3_block_public_access {
    AWS::S3::Bucket {
        Properties.PublicAccessBlockConfiguration EXISTS
        <<
            NIST AC-6: S3 Buckets must block all public access
        >>
    }
}

#############################################
# EKS Security Controls
#############################################

# Rule: EKS Cluster must have secrets encryption enabled
rule eks_encryption {
    AWS::EKS::Cluster {
        Properties.EncryptionConfig EXISTS
        <<
            NIST SC-28: EKS Cluster must have secrets encryption enabled
        >>
    }
}

# Rule: EKS Cluster must have private endpoint access
rule eks_private_endpoint {
    AWS::EKS::Cluster {
        Properties.ResourcesVpcConfig.EndpointPrivateAccess == true
        <<
            NIST SC-7: EKS Cluster must have private endpoint access enabled
        >>
    }
}

# Rule: EKS Cluster must have logging enabled
rule eks_logging {
    AWS::EKS::Cluster {
        Properties.Logging EXISTS
        <<
            NIST AU-2: EKS Cluster must have control plane logging enabled
        >>
    }
}

#############################################
# VPC Security Controls
#############################################

# Rule: VPCs must have tags
rule vpc_mandatory_tags {
    AWS::EC2::VPC {
        Properties.Tags EXISTS
        <<
            NIST CM-8: VPC must have mandatory tags
        >>
    }
}

# Rule: Security Groups must have tags
rule security_group_mandatory_tags {
    AWS::EC2::SecurityGroup {
        Properties.Tags EXISTS
        <<
            NIST CM-8: Security Groups must have mandatory tags
        >>
    }
}

#############################################
# IAM Security Controls
#############################################

# Rule: IAM Roles must have tags
rule iam_role_mandatory_tags {
    AWS::IAM::Role {
        Properties.Tags EXISTS
        <<
            NIST CM-8: IAM Roles must have mandatory tags
        >>
    }
}
