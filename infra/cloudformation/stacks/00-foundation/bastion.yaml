AWSTemplateFormatVersion: '2010-09-09'
Description: |
  Bastion Host for Network Testing and Administration
  Access via AWS Systems Manager Session Manager (no SSH port exposed)
  NIST 800-53 R5 Controls: AC-6 (Least Privilege), SC-7 (Boundary Protection)

Parameters:
  ProjectName:
    Type: String
    Default: infra-agent
    Description: Project name for resource naming

  Environment:
    Type: String
    AllowedValues:
      - dev
      - tst
      - prd
    Default: dev
    Description: Deployment environment

  PrivateSubnetId:
    Type: AWS::EC2::Subnet::Id
    Description: Private subnet for bastion host

  BastionSecurityGroupId:
    Type: AWS::EC2::SecurityGroup::Id
    Description: Security group for bastion host

  BastionInstanceProfileArn:
    Type: String
    Description: ARN of the bastion instance profile

  InstanceType:
    Type: String
    Default: t3a.medium
    AllowedValues:
      - t3a.micro
      - t3a.small
      - t3a.medium
    Description: EC2 instance type for bastion

  Owner:
    Type: String
    Default: platform-team
    Description: Team responsible for these resources

  IaCVersion:
    Type: String
    Default: '1.0.0'
    Description: Version of the IaC template

Resources:
  BastionHost:
    Type: AWS::EC2::Instance
    Properties:
      # Use SSM parameter for always-current Amazon Linux 2023 AMI
      ImageId: '{{resolve:ssm:/aws/service/ami-amazon-linux-latest/al2023-ami-kernel-default-x86_64}}'
      InstanceType: !Ref InstanceType
      SubnetId: !Ref PrivateSubnetId
      SecurityGroupIds:
        - !Ref BastionSecurityGroupId
      IamInstanceProfile: !Select [1, !Split ['/', !Ref BastionInstanceProfileArn]]
      # No public IP - access via SSM Session Manager only
      MetadataOptions:
        HttpTokens: required
        HttpPutResponseHopLimit: 1
        HttpEndpoint: enabled
      BlockDeviceMappings:
        - DeviceName: /dev/xvda
          Ebs:
            VolumeSize: 20
            VolumeType: gp3
            Encrypted: true
            DeleteOnTermination: true
      # Minimal UserData - bastion is only used for SSM tunneling
      # All tools (kubectl, helm, etc.) run on the local machine through the tunnel
      UserData:
        Fn::Base64: |
          #!/bin/bash
          # Minimal Bastion Setup - SSM Tunnel Only
          # No tools installed - all K8s/AWS operations done locally via tunnel

          exec > >(tee /var/log/bastion-setup.log) 2>&1
          echo "=== Bastion Setup Started: $(date) ==="

          # Update system packages for security
          echo "Updating system packages..."
          dnf update -y

          # SSM Agent is pre-installed on Amazon Linux 2023
          # Verify it's running
          systemctl status amazon-ssm-agent || systemctl start amazon-ssm-agent

          echo "=== Bastion Ready for SSM Tunneling: $(date) ==="

      Tags:
        - Key: Name
          Value: !Sub '${ProjectName}-${Environment}-bastion'
        - Key: Environment
          Value: !Ref Environment
        - Key: Owner
          Value: !Ref Owner
        - Key: SecurityLevel
          Value: internal
        - Key: IaC_Version
          Value: !Ref IaCVersion
        - Key: NIST_Control
          Value: AC-6_SC-7

Outputs:
  BastionInstanceId:
    Description: Instance ID of the bastion host
    Value: !Ref BastionHost
    Export:
      Name: !Sub '${ProjectName}-${Environment}-bastion-instance-id'

  BastionPrivateIp:
    Description: Private IP address of bastion host
    Value: !GetAtt BastionHost.PrivateIp
    Export:
      Name: !Sub '${ProjectName}-${Environment}-bastion-private-ip'

  SSMConnectCommand:
    Description: Command to connect to bastion via SSM
    Value: !Sub 'aws ssm start-session --target ${BastionHost} --region ${AWS::Region}'
