AWSTemplateFormatVersion: '2010-09-09'
Description: |
  IAM Roles for Infrastructure Agent - Least Privilege Access
  NIST 800-53 R5 Controls: AC-2 (Account Management), AC-6 (Least Privilege)

Parameters:
  ProjectName:
    Type: String
    Default: infra-agent
    Description: Project name for resource naming

  Environment:
    Type: String
    AllowedValues:
      - dev
      - tst
      - prd
    Default: dev
    Description: Deployment environment

  Owner:
    Type: String
    Default: platform-team
    Description: Team or individual responsible for these resources

  IaCVersion:
    Type: String
    Default: '1.0.0'
    Description: Version of the IaC template

  FlowLogsLogGroupArn:
    Type: String
    Description: ARN of the CloudWatch Log Group for VPC Flow Logs
    Default: ''

Conditions:
  HasFlowLogsLogGroup: !Not [!Equals [!Ref FlowLogsLogGroupArn, '']]

Metadata:
  AWS::CloudFormation::Interface:
    ParameterGroups:
      - Label:
          default: Project Configuration
        Parameters:
          - ProjectName
          - Environment
          - Owner
          - IaCVersion
      - Label:
          default: Dependencies
        Parameters:
          - FlowLogsLogGroupArn

Resources:
  #############################################
  # EKS Cluster IAM Role
  #############################################
  EksClusterRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName: !Sub '${ProjectName}-${Environment}-eks-cluster-role'
      Description: IAM role for EKS cluster control plane
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service: eks.amazonaws.com
            Action: sts:AssumeRole
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/AmazonEKSClusterPolicy
        - arn:aws:iam::aws:policy/AmazonEKSVPCResourceController
      Tags:
        - Key: Name
          Value: !Sub '${ProjectName}-${Environment}-eks-cluster-role'
        - Key: Environment
          Value: !Ref Environment
        - Key: Owner
          Value: !Ref Owner
        - Key: SecurityLevel
          Value: restricted
        - Key: IaC_Version
          Value: !Ref IaCVersion
        - Key: NIST_Control
          Value: AC-2_AC-6

  #############################################
  # EKS Node Group IAM Role
  #############################################
  EksNodeGroupRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName: !Sub '${ProjectName}-${Environment}-eks-nodegroup-role'
      Description: IAM role for EKS managed node groups
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service: ec2.amazonaws.com
            Action: sts:AssumeRole
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/AmazonEKSWorkerNodePolicy
        - arn:aws:iam::aws:policy/AmazonEKS_CNI_Policy
        - arn:aws:iam::aws:policy/AmazonEC2ContainerRegistryReadOnly
        - arn:aws:iam::aws:policy/AmazonSSMManagedInstanceCore
      Policies:
        # Secrets Manager read access for External Secrets Operator
        # NIST IA-5: Authenticator Management
        - PolicyName: !Sub '${ProjectName}-${Environment}-secrets-manager-read'
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - secretsmanager:GetSecretValue
                  - secretsmanager:DescribeSecret
                Resource:
                  - !Sub 'arn:aws:secretsmanager:${AWS::Region}:${AWS::AccountId}:secret:${ProjectName}-${Environment}-*'
      Tags:
        - Key: Name
          Value: !Sub '${ProjectName}-${Environment}-eks-nodegroup-role'
        - Key: Environment
          Value: !Ref Environment
        - Key: Owner
          Value: !Ref Owner
        - Key: SecurityLevel
          Value: internal
        - Key: IaC_Version
          Value: !Ref IaCVersion
        - Key: NIST_Control
          Value: AC-2_AC-6

  # Instance Profile for EKS Nodes
  EksNodeGroupInstanceProfile:
    Type: AWS::IAM::InstanceProfile
    Properties:
      InstanceProfileName: !Sub '${ProjectName}-${Environment}-eks-nodegroup-profile'
      Roles:
        - !Ref EksNodeGroupRole

  #############################################
  # Bastion Host IAM Role (SSM Access)
  #############################################
  BastionRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName: !Sub '${ProjectName}-${Environment}-bastion-role'
      Description: IAM role for Bastion host with SSM Session Manager access
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service: ec2.amazonaws.com
            Action: sts:AssumeRole
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/AmazonSSMManagedInstanceCore
      Policies:
        - PolicyName: !Sub '${ProjectName}-${Environment}-bastion-eks-access'
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              # Allow EKS describe for kubectl config
              - Effect: Allow
                Action:
                  - eks:DescribeCluster
                  - eks:ListClusters
                Resource: !Sub 'arn:aws:eks:${AWS::Region}:${AWS::AccountId}:cluster/${ProjectName}-${Environment}-*'
              # Allow STS for EKS authentication
              - Effect: Allow
                Action:
                  - sts:GetCallerIdentity
                Resource: '*'
      Tags:
        - Key: Name
          Value: !Sub '${ProjectName}-${Environment}-bastion-role'
        - Key: Environment
          Value: !Ref Environment
        - Key: Owner
          Value: !Ref Owner
        - Key: SecurityLevel
          Value: internal
        - Key: IaC_Version
          Value: !Ref IaCVersion
        - Key: NIST_Control
          Value: AC-2_AC-6

  # Instance Profile for Bastion
  BastionInstanceProfile:
    Type: AWS::IAM::InstanceProfile
    Properties:
      InstanceProfileName: !Sub '${ProjectName}-${Environment}-bastion-profile'
      Roles:
        - !Ref BastionRole

  #############################################
  # VPC Flow Logs IAM Role
  #############################################
  VpcFlowLogsRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName: !Sub '${ProjectName}-${Environment}-vpc-flowlogs-role'
      Description: IAM role for VPC Flow Logs to write to CloudWatch
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service: vpc-flow-logs.amazonaws.com
            Action: sts:AssumeRole
      Policies:
        - PolicyName: !Sub '${ProjectName}-${Environment}-flowlogs-policy'
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - logs:CreateLogStream
                  - logs:PutLogEvents
                  - logs:DescribeLogGroups
                  - logs:DescribeLogStreams
                Resource: !If
                  - HasFlowLogsLogGroup
                  - !Sub '${FlowLogsLogGroupArn}:*'
                  - !Sub 'arn:aws:logs:${AWS::Region}:${AWS::AccountId}:log-group:/${ProjectName}/${Environment}/vpc-flow-logs:*'
      Tags:
        - Key: Name
          Value: !Sub '${ProjectName}-${Environment}-vpc-flowlogs-role'
        - Key: Environment
          Value: !Ref Environment
        - Key: Owner
          Value: !Ref Owner
        - Key: SecurityLevel
          Value: internal
        - Key: IaC_Version
          Value: !Ref IaCVersion
        - Key: NIST_Control
          Value: AU-2_AC-6

  #############################################
  # AWS Load Balancer Controller IAM Role
  # (For IRSA - IAM Roles for Service Accounts)
  #############################################
  AwsLbControllerPolicy:
    Type: AWS::IAM::ManagedPolicy
    Properties:
      ManagedPolicyName: !Sub '${ProjectName}-${Environment}-aws-lb-controller-policy'
      Description: IAM policy for AWS Load Balancer Controller
      PolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Action:
              - iam:CreateServiceLinkedRole
            Resource: '*'
            Condition:
              StringEquals:
                iam:AWSServiceName: elasticloadbalancing.amazonaws.com
          - Effect: Allow
            Action:
              - ec2:DescribeAccountAttributes
              - ec2:DescribeAddresses
              - ec2:DescribeAvailabilityZones
              - ec2:DescribeInternetGateways
              - ec2:DescribeVpcs
              - ec2:DescribeVpcPeeringConnections
              - ec2:DescribeSubnets
              - ec2:DescribeSecurityGroups
              - ec2:DescribeInstances
              - ec2:DescribeNetworkInterfaces
              - ec2:DescribeTags
              - ec2:GetCoipPoolUsage
              - ec2:DescribeCoipPools
              - elasticloadbalancing:DescribeLoadBalancers
              - elasticloadbalancing:DescribeLoadBalancerAttributes
              - elasticloadbalancing:DescribeListeners
              - elasticloadbalancing:DescribeListenerCertificates
              - elasticloadbalancing:DescribeSSLPolicies
              - elasticloadbalancing:DescribeRules
              - elasticloadbalancing:DescribeTargetGroups
              - elasticloadbalancing:DescribeTargetGroupAttributes
              - elasticloadbalancing:DescribeTargetHealth
              - elasticloadbalancing:DescribeTags
              - elasticloadbalancing:DescribeTrustStores
            Resource: '*'
          - Effect: Allow
            Action:
              - cognito-idp:DescribeUserPoolClient
              - acm:ListCertificates
              - acm:DescribeCertificate
              - iam:ListServerCertificates
              - iam:GetServerCertificate
              - waf-regional:GetWebACL
              - waf-regional:GetWebACLForResource
              - waf-regional:AssociateWebACL
              - waf-regional:DisassociateWebACL
              - wafv2:GetWebACL
              - wafv2:GetWebACLForResource
              - wafv2:AssociateWebACL
              - wafv2:DisassociateWebACL
              - shield:GetSubscriptionState
              - shield:DescribeProtection
              - shield:CreateProtection
              - shield:DeleteProtection
            Resource: '*'
          - Effect: Allow
            Action:
              - ec2:AuthorizeSecurityGroupIngress
              - ec2:RevokeSecurityGroupIngress
            Resource: '*'
          - Effect: Allow
            Action:
              - ec2:CreateSecurityGroup
            Resource: '*'
          - Effect: Allow
            Action:
              - ec2:CreateTags
            Resource: 'arn:aws:ec2:*:*:security-group/*'
            Condition:
              StringEquals:
                ec2:CreateAction: CreateSecurityGroup
              'Null':
                aws:RequestTag/elbv2.k8s.aws/cluster: 'false'
          - Effect: Allow
            Action:
              - ec2:CreateTags
              - ec2:DeleteTags
            Resource: 'arn:aws:ec2:*:*:security-group/*'
            Condition:
              'Null':
                aws:RequestTag/elbv2.k8s.aws/cluster: 'true'
                aws:ResourceTag/elbv2.k8s.aws/cluster: 'false'
          - Effect: Allow
            Action:
              - ec2:AuthorizeSecurityGroupIngress
              - ec2:RevokeSecurityGroupIngress
              - ec2:DeleteSecurityGroup
            Resource: '*'
            Condition:
              'Null':
                aws:ResourceTag/elbv2.k8s.aws/cluster: 'false'
          - Effect: Allow
            Action:
              - elasticloadbalancing:CreateLoadBalancer
              - elasticloadbalancing:CreateTargetGroup
            Resource: '*'
            Condition:
              'Null':
                aws:RequestTag/elbv2.k8s.aws/cluster: 'false'
          - Effect: Allow
            Action:
              - elasticloadbalancing:CreateListener
              - elasticloadbalancing:DeleteListener
              - elasticloadbalancing:CreateRule
              - elasticloadbalancing:DeleteRule
            Resource: '*'
          - Effect: Allow
            Action:
              - elasticloadbalancing:AddTags
              - elasticloadbalancing:RemoveTags
            Resource:
              - 'arn:aws:elasticloadbalancing:*:*:targetgroup/*/*'
              - 'arn:aws:elasticloadbalancing:*:*:loadbalancer/net/*/*'
              - 'arn:aws:elasticloadbalancing:*:*:loadbalancer/app/*/*'
            Condition:
              'Null':
                aws:RequestTag/elbv2.k8s.aws/cluster: 'true'
                aws:ResourceTag/elbv2.k8s.aws/cluster: 'false'
          - Effect: Allow
            Action:
              - elasticloadbalancing:AddTags
              - elasticloadbalancing:RemoveTags
            Resource:
              - 'arn:aws:elasticloadbalancing:*:*:listener/net/*/*/*'
              - 'arn:aws:elasticloadbalancing:*:*:listener/app/*/*/*'
              - 'arn:aws:elasticloadbalancing:*:*:listener-rule/net/*/*/*'
              - 'arn:aws:elasticloadbalancing:*:*:listener-rule/app/*/*/*'
          - Effect: Allow
            Action:
              - elasticloadbalancing:ModifyLoadBalancerAttributes
              - elasticloadbalancing:SetIpAddressType
              - elasticloadbalancing:SetSecurityGroups
              - elasticloadbalancing:SetSubnets
              - elasticloadbalancing:DeleteLoadBalancer
              - elasticloadbalancing:ModifyTargetGroup
              - elasticloadbalancing:ModifyTargetGroupAttributes
              - elasticloadbalancing:DeleteTargetGroup
            Resource: '*'
            Condition:
              'Null':
                aws:ResourceTag/elbv2.k8s.aws/cluster: 'false'
          - Effect: Allow
            Action:
              - elasticloadbalancing:AddTags
            Resource:
              - 'arn:aws:elasticloadbalancing:*:*:targetgroup/*/*'
              - 'arn:aws:elasticloadbalancing:*:*:loadbalancer/net/*/*'
              - 'arn:aws:elasticloadbalancing:*:*:loadbalancer/app/*/*'
            Condition:
              StringEquals:
                elasticloadbalancing:CreateAction:
                  - CreateTargetGroup
                  - CreateLoadBalancer
              'Null':
                aws:RequestTag/elbv2.k8s.aws/cluster: 'false'
          - Effect: Allow
            Action:
              - elasticloadbalancing:RegisterTargets
              - elasticloadbalancing:DeregisterTargets
            Resource: 'arn:aws:elasticloadbalancing:*:*:targetgroup/*/*'
          - Effect: Allow
            Action:
              - elasticloadbalancing:SetWebAcl
              - elasticloadbalancing:ModifyListener
              - elasticloadbalancing:AddListenerCertificates
              - elasticloadbalancing:RemoveListenerCertificates
              - elasticloadbalancing:ModifyRule
            Resource: '*'

  #############################################
  # EBS CSI Driver IAM Role (for IRSA)
  #############################################
  EbsCsiDriverPolicy:
    Type: AWS::IAM::ManagedPolicy
    Properties:
      ManagedPolicyName: !Sub '${ProjectName}-${Environment}-ebs-csi-driver-policy'
      Description: IAM policy for EBS CSI Driver
      PolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Action:
              - ec2:CreateSnapshot
              - ec2:AttachVolume
              - ec2:DetachVolume
              - ec2:ModifyVolume
              - ec2:DescribeAvailabilityZones
              - ec2:DescribeInstances
              - ec2:DescribeSnapshots
              - ec2:DescribeTags
              - ec2:DescribeVolumes
              - ec2:DescribeVolumesModifications
            Resource: '*'
          - Effect: Allow
            Action:
              - ec2:CreateTags
            Resource:
              - 'arn:aws:ec2:*:*:volume/*'
              - 'arn:aws:ec2:*:*:snapshot/*'
            Condition:
              StringEquals:
                ec2:CreateAction:
                  - CreateVolume
                  - CreateSnapshot
          - Effect: Allow
            Action:
              - ec2:DeleteTags
            Resource:
              - 'arn:aws:ec2:*:*:volume/*'
              - 'arn:aws:ec2:*:*:snapshot/*'
          - Effect: Allow
            Action:
              - ec2:CreateVolume
            Resource: '*'
            Condition:
              StringLike:
                aws:RequestTag/ebs.csi.aws.com/cluster: 'true'
          - Effect: Allow
            Action:
              - ec2:CreateVolume
            Resource: '*'
            Condition:
              StringLike:
                aws:RequestTag/CSIVolumeName: '*'
          - Effect: Allow
            Action:
              - ec2:DeleteVolume
            Resource: '*'
            Condition:
              StringLike:
                ec2:ResourceTag/ebs.csi.aws.com/cluster: 'true'
          - Effect: Allow
            Action:
              - ec2:DeleteVolume
            Resource: '*'
            Condition:
              StringLike:
                ec2:ResourceTag/CSIVolumeName: '*'
          - Effect: Allow
            Action:
              - ec2:DeleteSnapshot
            Resource: '*'
            Condition:
              StringLike:
                ec2:ResourceTag/CSIVolumeSnapshotName: '*'
          - Effect: Allow
            Action:
              - ec2:DeleteSnapshot
            Resource: '*'
            Condition:
              StringLike:
                ec2:ResourceTag/ebs.csi.aws.com/cluster: 'true'
          - Effect: Allow
            Action:
              - kms:CreateGrant
              - kms:ListGrants
              - kms:RevokeGrant
            Resource: '*'
            Condition:
              Bool:
                kms:GrantIsForAWSResource: 'true'
          - Effect: Allow
            Action:
              - kms:Encrypt
              - kms:Decrypt
              - kms:ReEncrypt*
              - kms:GenerateDataKey*
              - kms:DescribeKey
            Resource: '*'

  #############################################
  # VPC CNI IAM Role (for custom networking)
  #############################################
  VpcCniPolicy:
    Type: AWS::IAM::ManagedPolicy
    Properties:
      ManagedPolicyName: !Sub '${ProjectName}-${Environment}-vpc-cni-policy'
      Description: IAM policy for VPC CNI custom networking
      PolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Action:
              - ec2:AssignPrivateIpAddresses
              - ec2:AttachNetworkInterface
              - ec2:CreateNetworkInterface
              - ec2:DeleteNetworkInterface
              - ec2:DescribeInstances
              - ec2:DescribeTags
              - ec2:DescribeNetworkInterfaces
              - ec2:DescribeInstanceTypes
              - ec2:DescribeSubnets
              - ec2:DetachNetworkInterface
              - ec2:ModifyNetworkInterfaceAttribute
              - ec2:UnassignPrivateIpAddresses
            Resource: '*'
          - Effect: Allow
            Action:
              - ec2:CreateTags
            Resource: 'arn:aws:ec2:*:*:network-interface/*'

Outputs:
  EksClusterRoleArn:
    Description: ARN of the EKS cluster IAM role
    Value: !GetAtt EksClusterRole.Arn
    Export:
      Name: !Sub '${ProjectName}-${Environment}-eks-cluster-role-arn'

  EksClusterRoleName:
    Description: Name of the EKS cluster IAM role
    Value: !Ref EksClusterRole
    Export:
      Name: !Sub '${ProjectName}-${Environment}-eks-cluster-role-name'

  EksNodeGroupRoleArn:
    Description: ARN of the EKS node group IAM role
    Value: !GetAtt EksNodeGroupRole.Arn
    Export:
      Name: !Sub '${ProjectName}-${Environment}-eks-nodegroup-role-arn'

  EksNodeGroupRoleName:
    Description: Name of the EKS node group IAM role
    Value: !Ref EksNodeGroupRole
    Export:
      Name: !Sub '${ProjectName}-${Environment}-eks-nodegroup-role-name'

  EksNodeGroupInstanceProfileArn:
    Description: ARN of the EKS node group instance profile
    Value: !GetAtt EksNodeGroupInstanceProfile.Arn
    Export:
      Name: !Sub '${ProjectName}-${Environment}-eks-nodegroup-profile-arn'

  BastionRoleArn:
    Description: ARN of the Bastion IAM role
    Value: !GetAtt BastionRole.Arn
    Export:
      Name: !Sub '${ProjectName}-${Environment}-bastion-role-arn'

  BastionInstanceProfileArn:
    Description: ARN of the Bastion instance profile
    Value: !GetAtt BastionInstanceProfile.Arn
    Export:
      Name: !Sub '${ProjectName}-${Environment}-bastion-profile-arn'

  VpcFlowLogsRoleArn:
    Description: ARN of the VPC Flow Logs IAM role
    Value: !GetAtt VpcFlowLogsRole.Arn
    Export:
      Name: !Sub '${ProjectName}-${Environment}-vpc-flowlogs-role-arn'

  AwsLbControllerPolicyArn:
    Description: ARN of the AWS Load Balancer Controller policy
    Value: !Ref AwsLbControllerPolicy
    Export:
      Name: !Sub '${ProjectName}-${Environment}-aws-lb-controller-policy-arn'

  EbsCsiDriverPolicyArn:
    Description: ARN of the EBS CSI Driver policy
    Value: !Ref EbsCsiDriverPolicy
    Export:
      Name: !Sub '${ProjectName}-${Environment}-ebs-csi-driver-policy-arn'

  VpcCniPolicyArn:
    Description: ARN of the VPC CNI policy
    Value: !Ref VpcCniPolicy
    Export:
      Name: !Sub '${ProjectName}-${Environment}-vpc-cni-policy-arn'
